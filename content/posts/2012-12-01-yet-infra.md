---
title: "Bootstrap YET infrastructure using Opscode Chef"
created_at: 2012-12-01 13:32:00 +0100
kind: article
published: true
tags: ['devops', 'howto', 'automation', 'chef', 'hpcloud', 'yet', 'nginx', 'tools']
---

In this article, we will details all the required steps to build up an environment to host this web site on *[Nginx](http://wiki.nginx.org/Main)* using  *[Chef](http://wiki.opscode.com/display/chef/About+Opscode+Chef)* on *[HP Cloud](https://www.hpcloud.com/)*.

<!-- more -->

### **bootstrap** an *HP cloud* instance using Knife

refer to our [HP cloud cheatsheet](/2012/11/hpcloud/) for details or you'll find the bootstrap command below which assume you've prepared your environment for `knife hp`

	% knife hp server create --flavor 100 --image 120 --ssh-key USERNAME -N ww1.yet.org --ssh-user ubuntu

If your Chef Server environment already contains your roles, cookbooks and recipe you can use `-r` to specify which roles you'd like to attach to your node when bootstrapping.
	
	% knife hp server create --flavor 100 --image 120 --ssh-key USERNAME -N ww1.yet.org -r 'role[base],role[yet_server]' --ssh-user ubuntu

***Note***: On Ubuntu 12.04 (precise), knife bootstrapping use the following template 

	./.rvm/gems/ruby-1.9.3-p286/gems/chef-10.16.2/lib/chef/knife/bootstrap/ubuntu12.04-gems.erb

You can change it and provide it with the --template argument, place it under ~/.chef

This template do the following :

* configure env variable http_proxy to knife_config[:bootstrap_proxy]
* install packages: *Ruby 1.8-dev, build-essential, wget, libruby1.8, rubygems
* update gems
* install gems: *ohai, chef*
* create /etc/chef directory
* output validation_key to /tmp/**validation.pem**, modifies (remove blank lines, mode 0600) and sent to /etc/chef 
* output **encrypted_databag_secret** to /tmp, modifies (remove blank lines, mode 0600) and send to /etc/chef
* output **Ohai hints** if @chef_config[:knife][:hints] to /etc/chef/ohai/hints
* output config_content -> /etc/chef/client.rb
* output first_boot.json -> /etc/chef/first-boot.json which contains {"run_list":[]}
* start chef

***Note***: to Synchronise clock if out of sync do:

	% sudo systemctl restart ntpd.service

For the following steps switch to your chef-repo, if you don't have one ready, you can clone one easily :

	% git clone git://github.com/opscode/chef-repo.git

***Note***: to avoid SSH issues, switch to non `StrictHostKeyChecking` for HP Cloud IP addresses in your `/etc/ssh/ssh_config`

	Host 15.*
   	  StrictHostKeyChecking no
      UserKnownHostsFile=/dev/null

### add **host** attribute to node

	#!json
	% knife node edit ww1.yet.org
	{
 	  "name": "ww1.yet.org",
 	  "chef_environment": "production_hpcloud",
 	  "normal": {
 	    "host": "www.yet.org",
 	    "tags": [
	 
 	    ],
 	    "runit": {
 	      "sv_bin": "/usr/bin/sv",
 	      "chpst_bin": "/usr/bin/chpst",
 	      "service_dir": "/etc/service",
 	      "sv_dir": "/etc/sv"
 	    },
 	    "chef_client": {
 	      "bin": "/usr/bin/chef-client"
 	    },
 	    "ohai": {
 	      "plugins": {
 	      }
 	    }
 	  },
 	  "run_list": [
 	    "role[base]",
 	    "role[yet_server]",
 	    "recipe[bootstrap::hostname]"
 	  ]
	}	

### **install cookbooks** to your repo

	% knife cookbook site install build-essential apt chef-client

For *Nginx* cookbook prefer 1.1.0 version available on github

	% git clone https://github.com/planetrobbie/nginx.git

### **upload cookbooks** to Hosted Chef

	% knife cookbook upload build-essential runit bluepill ohai apt chef-client nginx

### create a **new Environment** for HP Cloud from JSON file (optional)
 
##### File [chef-repo/environments/hpcloud.json](https://github.com/planetrobbie/chef-repo/blob/master/environments/hpcloud.json)
	
	#!json
	{
 	  "name": "production_hpcloud",
 	  "description": "HP Cloud Servers",
 	  "json_class": "Chef::Environment",
 	  "chef_type": "environment",
 	  "override_attributes": {
 	  "datacenter": "hpcloud"
 	  }
	}

	% knife environment from file environments/hpcloud.json
	% knife environment show production_hpcloud

### create a **new bootstrap cookbook**

This cookbook will install base packages: htop, iftop, vnstat, vim, tree, curl, ntp, ntpdate, byobu and do basic stuff.

	% knife cookbook create bootstrap

edit [cookbooks/bootstrap/recipes/default.rb](https://github.com/planetrobbie/chef-repo/blob/master/cookbooks/bootstrap/recipes/default.rb)

### create a **base role**

##### File [roles/base.rb](https://github.com/planetrobbie/chef-repo/blob/master/roles/base.rb)

	name "base"
	description "Base role applied to all nodes."
	
	run_list(
	  "recipe[apt]",
	  "recipe[chef-client]",
	  "recipe[bootstrap]"
	)


***Note***: chef-client recipe used to configure our node with a chef daemon which runs every 1800 seconds with a variance of 20 seconds and a log file `/var/log/chef`.

### **associate role to node**

If you didn't provide run_list while boostrapping with `-r` argument, you now have to associate your node with your run_list

	% knife node run_list add ww1.yet.org 'role[base], role[yet_server]'

### **Run** chef-client

You need to run chef-client one last time on remote node. It will run by itself afterwards due to chef-client recipe which is included in our base role.

	% knife ssh name:www.yet.org -x ubuntu "sudo chef-client"

**Note**: you need to update your DNS to resolve your host FQDN

### **Create yet_server role**

This role will be used to apply *Nginx*, yet_site recipes and disable default_site.

##### File [chef-repo/roles/yet_server.rb](https://github.com/planetrobbie/chef-repo/blob/master/roles/yet_server.rb)

	name            "yet_server"
	description     "YET static site server"
	
	run_list        "recipe[nginx]", "recipe[yet_site]"
	
	override_attributes(
	  "nginx" => {
	    "default_site_enabled" => false
	  }
	)


	% knife role from file roles/yet_server.rb
	% knife node run_list add ww1.yet.org "role[yet_server]"
	% knife search node "role:yet_server"

### **Patch nginx 1.1.0** cookbook to correct default_site_enabled 

##### File [cookbooks/nginx/definitions/nginx_site.rb](https://github.com/planetrobbie/chef-repo/blob/master/cookbooks/nginx/definitions/nginx_site.rb)

	only_if do ::File.symlink?("#{node['nginx']['dir']}/sites-enabled/#{params[:name]}") || ::File.symlink?("#{node['nginx']['dir']}/sites-enabled/000-#{params[:name]}") end

	% knife cookbook upload nginx

### **Create cookbook** yet_site
	
	% knife cookbook create yet_site

##### File [cookbooks/yet_site/recipe/default](https://github.com/planetrobbie/chef-repo/blob/master/cookbooks/yet_site/recipe/default)

	include_recipe "nginx"

	directory "/var/www" do
	  owner "www-data"
	  group "www-data"
	  mode "0775"
	end
	
	directory "/var/www/yet" do
	  owner "www-data"
	  group "www-data"
	  mode "0775"
	end
	
	group "www-data" do
	  members ['ubuntu']
	end
	
	template "#{node['nginx']['dir']}/sites-available/yet" do
	  source "yet.erb"
	  owner "root"
	  group "root"
	  mode 00644
	end
	
	nginx_site "yet" do
	  action :enable
	end

##### File [cookbooks/yet_site/templates/default/yet.erb](https://github.com/planetrobbie/chef-repo/blob/master/cookbooks/yet_site/templates/default/yet.erb)
	
	server {
	  listen 80;
	  server_name yet.org;
	
	  root /var/www/yet;
	}

### Rake tasks for Rsync deployment

	# encoding: utf-8

	ssh_user              = "ubuntu@yet"
	remote_root           = "/var/www/yet/"

	desc "builds and deploy"
	task :deploy do
	  puts "*** compile yet ***"
	  system "nanoc compile"
	  puts "*** deploy yet ***"
	  system "rsync -avz --delete output/* #{ssh_user}:#{remote_root}"
	end

### Update **default security group**

to allow TCP/80, 
	
	% hpcloud securitygroups:rules:add default tcp -p 80..80
	% hpcloud securitygroups:rules default

refer to my [*HP Cloud* cheatsheet](/2012/11/hpcloud/) to install hpcloud.

### Upgrade all nodes packages

	% knife ssh name:* -x ubuntu "sudo aptitude upgrade -y"

### Saving your node as JSON

[*Spiceweasel*](http://wiki.opscode.com/display/chef/Spiceweasel) is maybe a good solution to rebuild our infrastructure from scratch ?
		
	% knife node show ww1.yet.org -Fj > ./ww1-yet.json

### To create another node based on the same model

	% knife hp server create --flavor 100 --image 120 --ssh-key USERNAME --ssh-user ubuntu
	% knife node from file ../ww1-yet.json

## Links, Tips & Tricks

* [A Brief Chef Tutorial (From Concentrate)](http://blog.afistfulofservers.net/post/2011/03/16/a-brief-chef-tutorial-from-concentrate/) article 
* To display the list of package available for update on Ubuntu/Debian, use :

		% /usr/lib/update-notifier/apt-check -p --human-readable

* Attributes [docs](http://wiki.opscode.com/display/chef/Attributes) and [samples](http://wiki.opscode.com/display/chef/Setting+Attributes+(Examples)) on *Chef* Wiki.

* Dump a node to JSON to get all its details 
	
	% knife search node "name:NODENAME" -F json

* Get uptimes of all your hosts or run any command remotly

	% knife ssh "id:*" "uptime"

* Some Awk [one liners](http://www.softpanorama.org/Tools/Awk/awk_one_liners.shtml)

## Conclusion

As you've seen in this article, building up *YET* using *Opscode Chef* is great because if we need to build it again we won't have to redo all the steps one more time. It is just necessary to bootstrap a new node in any cloud, he will then come up ready to receive our content using Rsync and will publish it using Nginx.